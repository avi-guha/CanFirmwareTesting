/*
 * CAN Bus Receiver - "Hello World"
 * Receives "hello world" message from another microcontroller via CAN bus
 * Upload this code to Microcontroller #2
 */

#include <Arduino.h>
#include <SPI.h>
#include <mcp2515.h>

// MCP2515 Pinout for ESP32 Pico Kit v4.1
// CS   -> GPIO 5
// MOSI -> GPIO 23 (default SPI)
// MISO -> GPIO 19 (default SPI)
// SCK  -> GPIO 18 (default SPI)

#define CAN_CS_PIN 5

MCP2515 mcp2515(CAN_CS_PIN);

void setup() {
  Serial.begin(115200);
  while (!Serial) {
    ; // Wait for serial port to connect
  }
  
  delay(1000);
  Serial.println("\n=== CAN Bus Receiver ===");
  Serial.println("Waiting for 'hello world' message");
  
  // Initialize SPI
  SPI.begin();
  
  // Initialize MCP2515
  mcp2515.reset();
  
  // Set CAN bit rate to 500kbps with 16MHz crystal
  MCP2515::ERROR result = mcp2515.setBitrate(CAN_500KBPS, MCP_16MHZ);
  
  if (result == MCP2515::ERROR_OK) {
    Serial.println("✓ Bitrate set to 500kbps @ 16MHz");
  } else {
    Serial.println("✗ Error setting bitrate");
  }
  
  // Set to normal mode
  result = mcp2515.setNormalMode();
  
  if (result == MCP2515::ERROR_OK) {
    Serial.println("✓ MCP2515 initialized successfully!");
  } else {
    Serial.println("✗ Error: Check wiring!");
  }
  
  Serial.println("\nListening for messages...");
}

void loop() {
  // Check for incoming CAN messages
  struct can_frame rxFrame;
  
  if (mcp2515.readMessage(&rxFrame) == MCP2515::ERROR_OK) {
    // Check if this is our "hello world" message (CAN ID 0x100)
    if (rxFrame.can_id == 0x100) {
      Serial.print("✓ Received from CAN ID 0x");
      Serial.print(rxFrame.can_id, HEX);
      Serial.print(": ");
      
      // Print the message as text
      for (int i = 0; i < rxFrame.can_dlc; i++) {
        Serial.print((char)rxFrame.data[i]);
      }
      Serial.println();
    } else {
      // Other messages
      Serial.print("Message from ID 0x");
      Serial.print(rxFrame.can_id, HEX);
      Serial.print(" (Length: ");
      Serial.print(rxFrame.can_dlc);
      Serial.println(" bytes)");
    }
  }
  
  // Small delay to prevent overwhelming the CPU
  delay(10);
}
